<?xml version="1.0"?>
<!--
 conjoon
 (c) 2002-2010 siteartwork.de/conjoon.org
 licensing@conjoon.org

 $Author$
 $Id$
 $Date$
 $Revision$
 $LastChangedDate$
 $LastChangedBy$
 $URL$
-->

<!--
 This build file will process all files/directories related to the conjoon
 project into the ../build directory.

 Notice:
 This build file will also call the build files
  build_login.xml
 and
  build_css.xml

 @author Thorsten Suckow-Homberg <ts@siteartwork.de>
-->
<!--
/**
* @todo @REV@
* @todo database
*/
-->
<project name="conjoon" default="refresh" basedir="../">

   <property file="./build-tools/build.properties" />
   <includepath classpath="./build-tools/phing" />

   <property name="force.build_zend" value="0" />


    <taskdef name="headrevision" classname="tasks.HeadRevisionTask" />
    <headrevision
            dir="./"
            passthru="false"
            checkreturn="true"
            revisionProperty="svn.lastrevision"
    />

   <target name="build_export">
    <svnexport
       force="true"
       nocache="true"
       repositoryurl="./"
       todir="./build/complete"/>
    <docblox title="conjoon PHP library" destdir="./build/complete/src/corelib/php/docs">
     <fileset dir="./src/corelib/php/library">
      <include name="**/*.php" />
     </fileset>
    </docblox>
   </target>

   <target name="build_libs">
     <phingcall target="build_zend" />
     <phingcall target="build_conjoon_php" />
   </target>

   <target name="build_license">
    <copy file="./LICENSE.txt"
          tofile="./build/build/htdocs/install/LICENSE.txt"
          overwrite="true"
     />
   </target>

    <target name="build_zend">
     <available file="./build/build/htdocs/install/files/conjoon_libs/Zend" property="zend.exists" value="exists" />
     <if>
       <or>
        <equals arg1="${force.build_zend}" arg2="1" />
        <not>
        <equals arg1="${zend.exists}" arg2="exists" />
        </not>
       </or>
     <then>
      <delete dir="./build/build/htdocs/install/files/conjoon_libs/Zend" />
      <copy todir="./build/build/htdocs/install/files/conjoon_libs" includeemptydirs="true">
       <fileset dir="./vendor/zendframework/library">
         <exclude name="**/.svn" />
       </fileset>
       <filterchain>
          <filterreader classname="filters.RemoveRequire" />
      </filterchain>
      </copy>
      </then>
     </if>
    </target>

    <target name="build_datastore">
      <delete dir="./build/build/htdocs/install/files/datastore" />
      <copy todir="./build/build/htdocs/install/files/datastore" includeemptydirs="true">
       <fileset dir="./src/datastore">
         <exclude name="**/.svn" />
       </fileset>
       <filterchain>
          <filterreader classname="filters.ProcessDevFragments" />
      </filterchain>
      </copy>
    </target>

    <target name="build_config_cache">
      <delete dir="./build/build/htdocs/install/files/_configCache" />
      <copy todir="./build/build/htdocs/install/files/_configCache" includeemptydirs="true">
       <fileset dir="./src/www/htdocs/_configCache">
         <exclude name="**/.svn" />
         <exclude name="**/CHANGELOG.txt" />
         <exclude name="**/config.ini.php" />
       </fileset>
      </copy>
    </target>

    <target name="build_conjoon_php">
      <delete dir="./build/build/htdocs/install/files/conjoon_libs/Conjoon" />
      <copy todir="./build/build/htdocs/install/files/conjoon_libs/Conjoon" includeemptydirs="true">
       <fileset dir="./src/corelib/php/library/Conjoon">
         <include name="**/*.php" />
       </fileset>
       <filterchain>
          <filterreader classname="filters.ProcessDevFragments" />
          <replacetokens begintoken="@" endtoken="@">
            <token key="REV" value="${svn.lastrevision}" />
          </replacetokens>
          <filterreader classname="filters.RemoveRequire" />
      </filterchain>
      </copy>
    </target>

   <!-- builds ext js into htdocs. -->
   <target name="build_ext">
     <delete dir="./build/build/htdocs/install/files/js/extjs" />
     <copy file="./vendor/extjs/ext-all.js" tofile="./build/build/htdocs/install/files/js/extjs/ext-all.js" overwrite="true"/>
     <copy file="./vendor/extjs/adapter/ext/ext-base.js" tofile="./build/build/htdocs/install/files/js/extjs/ext-base.js" overwrite="true"/>
     <copy todir="./build/build/htdocs/install/files/js/extjs/resources" includeemptydirs="true">
      <fileset dir="./vendor/extjs/resources">
        <include name="**/ext-all.css" />
        <include name="**/*.ico" />
        <include name="**/*.png" />
        <include name="**/*.gif" />
        <include name="**/*.jpg" />
      </fileset>
     </copy>
   </target>

   <!-- builds conjoon js into htdocs -->
   <target name="build_conjoon_js">
        <delete dir="./build/build/htdocs/install/files/js/conjoon" />

        <copy file="./build-tools/header.txt"
            tofile="./build/build/htdocs/install/files/js/conjoon/conjoon-all.js"
            overwrite="true"
        />
        <copy file="./build-tools/header.txt"
            tofile="./build/build/htdocs/install/files/js/conjoon/conjoon-all-debug.js"
            overwrite="true"
        />

        <php function="tempnam" returnProperty="conjoon.jsmerge.tempfile">
          <param value="/tmp" />
          <param value="conjoon.jsmerge" />
        </php>

        <append destFile="${conjoon.jsmerge.tempfile}">
          <filterchain>
           <filterreader classname="filters.AddLinebreak" />
          </filterchain>
          <filelist dir="./" listfile="./build-tools/merge_list_js.txt" />
        </append>

        <append file="${conjoon.jsmerge.tempfile}" destFile="./build/build/htdocs/install/files/js/conjoon/conjoon-all-debug.js" />

        <exec
            command='java -jar ${yuicompressor_path} -v --type js -o "${conjoon.jsmerge.tempfile}" "${conjoon.jsmerge.tempfile}"'
            dir="./"
            passthru="true"
            checkreturn="true"
        />
        <append file="${conjoon.jsmerge.tempfile}" destFile="./build/build/htdocs/install/files/js/conjoon/conjoon-all.js" />

        <delete file="${conjoon.jsmerge.tempfile}" verbose="true" failonerror="true" />
   </target>

   <!-- builds conjoon related css and resources -->
   <target name="build_css">
    <delete dir="./build/build/htdocs/install/files/js/conjoon/resources" />
    <phing phingfile="./build-tools/build_css.xml" haltonfailure="true" inheritRefs="false" inheritAll="false" />
    <copy todir="./build/build/htdocs/install/files/js/conjoon/resources" includeemptydirs="true">
     <fileset dir="./src/corelib/js/resources">
       <exclude name="**/*.css" />
       <exclude name="**/Thumbs.db" />
       <exclude name="**/.svn" />
       <!--exclude name="**/README.txt" />
       <exclude name="**/LICENSE.txt" />
       <exclude name="**/CREDITS.txt" /-->
       <exclude name="**/CHANGELOG.txt" />
     </fileset>
    </copy>
    <!-- as follows the subproject extensions for conjoon -->
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-grid-gridviewmenuplugin" />
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-youtubeplayer" />
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-toastwindow" />
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-livegrid" />
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-wiz" />
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-flexaccord" />
     <delete dir="./build/build/htdocs/install/files/js/ext-ux-flashcontrol" />
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-grid-gridviewmenuplugin" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-grid-gridviewmenuplugin/src">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-youtubeplayer" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-youtubeplayer/src">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-toastwindow" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-toastwindow">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-livegrid" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-livegrid/build">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-wiz" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-wiz/src">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-flexaccord" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-flexaccord/build">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
     <copy todir="./build/build/htdocs/install/files/js/ext-ux-flashcontrol" includeemptydirs="true">
      <fileset dir="./vendor/ext-ux-flashcontrol/build">
        <include name="**/*.css" />
        <include name="**/*.jpg" />
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
     </copy>
      <copy todir="./build/build/htdocs/install/files/js/soundmanager/swf" includeemptydirs="true">
      <fileset dir="./vendor/soundmanager/swf">
        <include name="**/*.swf" />
      </fileset>
     </copy>
  </target>

   <!-- rebuilds scripts related to login process -->
   <target name="build_login">
    <phing phingfile="./build-tools/build_login.xml" haltonfailure="true" inheritRefs="false" inheritAll="false" />
   </target>


   <target name="prepare">
     <mkdir dir="./build" />
     <mkdir dir="./build/build" />
     <mkdir dir="./build/complete" />
   </target>

   <!-- rebuilds the application folder -->
   <target name="build_application">
     <delete dir="./build/build/htdocs/install/files/conjoon_application" />
     <copy todir="./build/build/htdocs/install/files/conjoon_application" includeemptydirs="true">
       <fileset dir="./src/www/application">
         <exclude name="cache/**" />
         <exclude name="**/.svn" />
         <exclude name="**/sandbox.phtml" />
         <!--exclude name="**/README.txt" />
         <exclude name="**/LICENSE.txt" />
         <exclude name="**/CREDITS.txt" /-->
         <exclude name="**/CHANGELOG.txt" />
       </fileset>
       <filterchain>
        <filterreader classname="filters.ProcessDevFragments" />
        <filterreader classname="filters.RemoveRequire" />
       </filterchain>
     </copy>
   </target>

   <!-- rebuilds the htdocs folder -->
   <target name="build_htdocs">
     <available file="./build/build/htdocs" property="htdocs.exists" value="exists" />

     <if>
       <equals arg1="${htdocs.exists}" arg2="exists" />
      <then>
       <delete>
         <fileset dir="./build/build/htdocs">
           <exclude name="js/**" />
           <exclude name="install/files/conjoon_libs/Zend/**" />
         </fileset>
       </delete>
      </then>
     </if>
     <copy todir="./build/build/htdocs" includeemptydirs="true">
       <fileset dir="./">
        <include name="INSTALL.txt" />
        <include name="CHANGELOG.txt" />
        <include name="LICENSE.txt" />
       </fileset>
       <fileset dir="./src/www/htdocs">
         <exclude name="**/.svn" />
         <!--exclude name="**/README.txt" />
         <exclude name="**/LICENSE.txt" />
         <exclude name="**/CREDITS.txt" /-->
         <exclude name="**/CHANGELOG.txt" />
         <exclude name="_configCache/**" />
         <exclude name="**/config.ini.php" />
         <exclude name="**/.htaccess" />
         <exclude name="**/ext-config.js" />
         <exclude name="**/startup.js" />
         <exclude name="**/startup.iphone.js" />
       </fileset>
       <filterchain>
        <filterreader classname="filters.ProcessDevFragments" />
        <filterreader classname="filters.RemoveRequire" />
       </filterchain>
     </copy>
    <phingcall target="build_conjoon_js" />
    <phingcall target="build_css" />
    <phingcall target="build_login" />
    <phingcall target="build_ext" />
   </target>

   <target name="php_tests">
    <phpunit
        printsummary="true"
        haltonerror="true"
        haltonfailure="true"
        bootstrap="./src/corelib/php/tests/TestHelper.php"
        haltonincomplete="true"
        haltonskipped="true"
    >
     <batchtest>
      <fileset dir="./src/corelib/php/tests">
       <include name="**/*Test.php"/>
      </fileset>
     </batchtest>
    </phpunit>
   </target>

   <!-- refreshes build contents except for ../build/libs/Zend -->
   <target name="refresh" depends="prepare">
    <phingcall target="build_export" />
    <phingcall target="build_htdocs" />
    <phingcall target="build_config_cache" />
    <phingcall target="build_application" />
    <phingcall target="build_libs" />
    <phingcall target="build_datastore" />
    <phingcall target="build_license" />
   </target>

   <!-- completely removes the build dir -->
   <target name="rebuild">
     <property name="force.build_zend" value="1" />
     <delete dir="./build" />
     <phingcall target="refresh" />
    </target>

</project>
