Ext.namespace("Ext.ux.grid");Ext.ux.grid.GridViewMenuPlugin=Ext.extend(Object,{_grid:null,_view:null,_menuBtn:null,colMenu:null,cm:null,_lastGroupField:null,_groupMenu:null,_keepItems:null,init:function(A){if(A.enableHdMenu===false){return }this._keepItems=[];this._grid=A;A.enableHdMenu=false;this._view=A.getView();this._view.initElements=this._view.initElements.createSequence(this.initElements,this);this._view.initData=this._view.initData.createSequence(this.initData,this);this._view.destroy=this._view.destroy.createInterceptor(this._destroy,this);this.colMenu=new Ext.menu.Menu({id:A.id+"-hcols-menu",subMenuAlign:"tr-tl?"});this.colMenu.on("afterrender",this._beforeColMenuShow,this);this.colMenu.on("beforeshow",this._beforeColMenuShow,this);this.colMenu.on("beforeremove",this._beforeColMenuRemove,this);this.colMenu.on("itemclick",this._handleHdMenuClick,this)},_beforeColMenuRemove:function(B,A){if(this._keepItems.indexOf(A)!=-1){return false}},_handleHdMenuClick:function(A,B){return this._view.handleHdMenuClickDefault(A,B)},_beforeColMenuShow:function(G){this.colMenu.suspendEvents();for(var E=0,B=this._keepItems.length;E<B;E++){this.colMenu.remove(this._keepItems[E],false)}this.colMenu.resumeEvents();this._view.beforeColMenuShow.call(this,G);if(this._view.enableGroupingMenu&&this.colMenu){if(!this._groupMenu){this._groupMenu=new Ext.menu.Menu({id:this._grid.id+"-hgroupcols-menu"});this._groupMenu.on("afterrender",this._onBeforeGroupMenuShow,this);this._groupMenu.on("beforeshow",this._onBeforeGroupMenuShow,this);this._groupMenu.on("itemclick",this._onGroupMenuItemClick,this);var D={itemId:"showGroups",text:this._view.showGroupsText,menu:this._groupMenu};if(this._view.enableNoGroups){var F=this._view.getGroupField();Ext.apply(D,{checked:!!F,checkHandler:function(H,I){if(I){this._view.enableGrouping=true;this._grid.store.groupBy(this._lastGroupField)}else{this._view.enableGrouping=false;this._grid.store.clearGrouping()}},scope:this})}var C=new Ext.menu.Separator();var A=this._view.enableNoGroups?new Ext.menu.CheckItem(D):new Ext.menu.Item(D);this._keepItems.unshift(C,A)}}for(var E=0,B=this._keepItems.length;E<B;E++){this.colMenu.add(this._keepItems[E])}if(this._view.enableNoGroups){this._keepItems[1].setChecked(!!this._view.getGroupField(),true)}},_handleHdDown:function(B,A){if(Ext.fly(A).hasClass("x-grid3-hd-btn")){B.stopEvent();this.colMenu.show(A,"tr-br?")}},_onBeforeGroupMenuShow:function(){var A=this._view.cm,C=A.getColumnCount(),D=this._view.getGroupField();this._groupMenu.removeAll();for(var B=0;B<C;B++){this._groupMenu.add(new Ext.menu.CheckItem({itemId:"groupcol-"+A.getColumnId(B),text:A.getColumnHeader(B),checked:A.getDataIndex(B)==D,hideOnClick:true,disabled:A.config[B].groupable===false}))}},_onGroupMenuItemClick:function(C){var A=this._view.cm,B=A.getIndexById(C.itemId.substr(9)),D=A.getDataIndex(B);if(B!=-1){if(C.checked){this._view.enableGrouping=false;this._grid.store.clearGrouping()}else{this._view.enableGrouping=true;this._grid.store.groupBy(D);this._lastGroupField=this._view.getGroupField()}}},_getMenuButton:function(){var A=document.createElement("a");A.className="ext-ux-grid-gridviewmenuplugin-menuBtn x-grid3-hd-btn";A.href="#";return new Ext.Element(A)},initData:function(){this.cm=this._view.cm;if(this._view.enableGroupingMenu){this._lastGroupField=this._view.getGroupField()}},initElements:function(){this.menuBtn=this._getMenuButton();this._view.mainHd.dom.appendChild(this.menuBtn.dom);this.menuBtn.on("click",this._handleHdDown,this);this.menuBtn.dom.style.height=(this._view.mainHd.dom.offsetHeight-1)+"px"},_destroy:function(){if(this.colMenu){this.colMenu.un("beforeremove",this._beforeColMenuRemove,this);this.colMenu.removeAll(true);Ext.menu.MenuMgr.unregister(this.colMenu);if(this.colMenu.getEl()){this.colMenu.getEl().remove()}delete this.colMenu}if(this._groupMenu){this._groupMenu.removeAll(true);Ext.menu.MenuMgr.unregister(this._groupMenu);delete this._groupMenu}if(this._menuBtn){this._menuBtn.remove();delete this._menuBtn}}});